<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cmdi.dao.SaopinDao">

  <resultMap type="com.cmdi.model.SaoPinData" id="selectsaopindatamap"></resultMap>
  <select id="selectlaxiansaopindata" parameterType="map" resultMap="selectsaopindatamap">
	  SELECT `timestamp`,longitude,latitude,earfcn,r0_rp AS rs,f.pci pci,f.gridid gridid
	  FROM  ${saoPinTableName} f
	  WHERE pci IS NOT NULL AND longitude IS NOT NULL AND latitude IS NOT NULL
	  and f.earfcn in
	  <foreach collection="earfcnlist" index="index" item="item" open="("
			   separator="," close=")">
		  #{item,jdbcType=INTEGER}
	  </foreach>


	</select>
	<select id="selectsaopindata" parameterType="map" resultMap="selectsaopindatamap">
		SELECT f.`timestamp`,f.longitude,f.latitude,f.earfcn,f.r0_rp as rs ,max(f.pci) pci,max(f.gridid) gridid
		FROM ${saoPinTableName} f
		LEFT JOIN (
		SELECT `timestamp`,longitude,latitude,earfcn,MAX(r0_rp) AS rs,GROUP_CONCAT(CONCAT_WS(':',f.pci,f.r0_rp)) pr
		FROM  ${saoPinTableName} f
		WHERE pci IS NOT NULL AND longitude IS NOT NULL AND latitude IS NOT NULL
		GROUP BY `timestamp`,longitude,latitude,earfcn
		) a ON  a.timestamp=f.timestamp AND a.longitude=f.longitude AND a.latitude=f.latitude AND a.earfcn=f.earfcn AND a.rs=f.r0_rp
		WHERE a.pr IS NOT NULL and f.pci is not null and f.longitude is not null and f.latitude is not null
		and f.earfcn in
		<foreach collection="earfcnlist" index="index" item="item" open="("
				 separator="," close=")">
			#{item,jdbcType=INTEGER}
		</foreach>
		group by f.timestamp,f.longitude,f.latitude,f.earfcn,f.r0_rp


	</select>
	<insert id="insertsaopinaddrmastercell" parameterType="map">
    INSERT INTO ${rsrpTableName} (date,timestamp,longitude,latitude,earfcn,pci,rs,cellid,gridid)
    VALUES
	    <foreach collection="splist" item="item" index="index" separator=",">
	      (
	      #{date,jdbcType=VARCHAR},
	      #{item.timestamp,jdbcType=VARCHAR},
	      #{item.longitude,jdbcType=DOUBLE},
	      #{item.latitude,jdbcType=DOUBLE},
	      #{item.earfcn,jdbcType=INTEGER},
	      #{item.pci,jdbcType=INTEGER},
	      #{item.rs,jdbcType=DOUBLE},
	      #{item.mastercellId,jdbcType=INTEGER},
	      #{item.gridid,jdbcType=VARCHAR}
	      )
	    </foreach>
	</insert>
	
	<delete id="deletesaopinaddrmastercell" parameterType="map">
    delete 
    from ${rsrpTableName}
    where date=#{date,jdbcType=VARCHAR}
	</delete>
	
	<insert id="insertmastercellcover" parameterType="map">
    INSERT INTO ${coverTableName}(date,earfcn,cellid,coverf100,coverf110,coverf120)
    VALUES
	    <foreach collection="coverlist" item="item" index="index" separator=",">
	      (
	      #{date,jdbcType=VARCHAR},
	      #{item.earfcn,jdbcType=INTEGER},
	      #{item.mastercellId,jdbcType=INTEGER},
	      ROUND(#{item.countf100,jdbcType=DOUBLE}/#{item.countall,jdbcType=DOUBLE},4),
		  ROUND(#{item.countf110,jdbcType=DOUBLE}/#{item.countall,jdbcType=DOUBLE},4),
		  ROUND(#{item.countf120,jdbcType=DOUBLE}/#{item.countall,jdbcType=DOUBLE},4)
	      )
	    </foreach>
	</insert>
	
	<delete id="deletemastercellcover" parameterType="map">
    delete 
    from ${coverTableName}
    where date=#{date,jdbcType=VARCHAR}
	</delete>

</mapper>